name: Release Installer

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version: '3.27.1'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: x86_64-pc-windows-msvc

      - name: Create dummy .env
        run: New-Item -ItemType File -Path .env -Force

      # --- PHASE 1: BUILD GAME CLIENT ---
      - name: Build Game Client (Flutter)
        run: |
          flutter clean
          flutter pub get
          flutter build windows --release

      - name: Rename Game Exe
        run: |
          if (Test-Path "build/windows/x64/runner/Release/launcher.exe") {
            Move-Item "build/windows/x64/runner/Release/launcher.exe" "build/windows/x64/runner/Release/crystal_launcher.exe" -Force
          }

      - name: Create Game Payload Zip
        run: |
          $payloadDir = "installer/assets/payload"
          if (!(Test-Path $payloadDir)) {
            New-Item -ItemType Directory -Force -Path $payloadDir
          }
          Compress-Archive -Path "build/windows/x64/runner/Release/*" -DestinationPath "$payloadDir/game_payload.zip" -Force

      # --- PHASE 2: BUILD INSTALLER UI ---
      - name: Build Installer UI (Flutter)
        working-directory: installer
        run: |
          flutter clean
          flutter pub get
          flutter build windows --release

      # --- PHASE 2.5: BUILD RUST DLL ---
      - name: Build Rust Native DLL
        working-directory: native
        run: cargo build --release --lib

      - name: Copy DLL to Installer Distribution
        run: |
          Copy-Item "native/target/release/CrystalNative.dll" "installer/build/windows/x64/runner/Release/installer_native.dll" -Force

      # --- PHASE 3: BUILD BOOTSTRAPPER ---
      - name: Create Installer Payload Zip
        run: |
          Compress-Archive -Path "installer/build/windows/x64/runner/Release/*" -DestinationPath "bootstrapper/installer_payload.zip" -Force

      - name: Copy Bootstrapper Icon
        run: |
          Copy-Item "native/app_icon.ico" "bootstrapper/app_icon.ico" -Force

      - name: Build Bootstrapper (Rust)
        working-directory: bootstrapper
        run: |
          ls -Force
          cargo build --release

      - name: Prepare Release Artifact
        run: |
          Copy-Item "bootstrapper/target/release/crystal_bootstrapper.exe" "CTSMP_Installer.exe" -Force

      - name: Sign Installer (Self-Signed)
        shell: powershell
        run: |
          # Create Self-Signed Certificate
          $cert = New-SelfSignedCertificate -Type CodeSigningCert -Subject "CN=CrystalTidesSMP Project" -CertStoreLocation Cert:\CurrentUser\My
          $certPath = "cert.pfx"
          $certPassword = ConvertTo-SecureString -String "CrystalPass123" -Force -AsPlainText
          Export-PfxCertificate -Cert $cert -FilePath $certPath -Password $certPassword

          # Locate Signtool (usually in Windows SDK)
          $signtool = Get-ChildItem -Path "C:\Program Files (x86)\Windows Kits" -Recurse -Filter "signtool.exe" | Sort-Object FullName -Descending | Select-Object -First 1
          
          if ($signtool) {
            Write-Host "Found Signtool at: $($signtool.FullName)"
            & $signtool.FullName sign /f $certPath /p "CrystalPass123" /fd SHA256 /t http://timestamp.digicert.com /q "CTSMP_Installer.exe"
            Write-Host "Signing completed."
          } else {
            Write-Error "Signtool not found."
            exit 1
          }

      # --- PHASE 4: RELEASE ---
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: CTSMP_Installer.exe
          draft: false
          prerelease: false
