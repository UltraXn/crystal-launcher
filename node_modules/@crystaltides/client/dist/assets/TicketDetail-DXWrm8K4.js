import{j as s,p as k,m as R,d as D,F as E}from"./ui-vendor-bChcnJbH.js";import{i as z,u as N,r as n}from"./react-vendor-C4HomasF.js";import{u as C,a as I}from"./zod-CBLu0rk-.js";import{a as F}from"./ticket-CdYdQmzu.js";import{u as M,s as d}from"./index-0L0CuJC5.js";import{u as q}from"./utils-vendor-DpehPmnF.js";function P(){const{id:t}=z(),{user:l}=M(),{t:c}=q(),m=N(),u=n.useRef(null),[e,x]=n.useState(null),[h,f]=n.useState([]),[b,y]=n.useState(!0),{register:j,handleSubmit:v,reset:w,formState:{isSubmitting:p}}=C({resolver:I(F)}),S=n.useCallback(()=>{setTimeout(()=>{u.current&&u.current.scrollIntoView({behavior:"smooth"})},100)},[]),g=n.useCallback(async()=>{if(t)try{const{data:a,error:r}=await d.from("tickets").select("*").eq("id",t).single();if(r)throw r;x(a);const{data:i,error:o}=await d.from("ticket_messages").select("*").eq("ticket_id",t).order("created_at",{ascending:!0});if(o)throw o;f(i||[]),y(!1)}catch(a){console.error("Error fetching details:",a),m("/support")}},[t,m]);n.useEffect(()=>{if(t&&l){g();const a=d.channel(`ticket_chat_${t}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"ticket_messages",filter:`ticket_id=eq.${t}`},r=>{f(i=>i.some(o=>o.id===r.new.id)?i:[...i,r.new])}).subscribe();return()=>{d.removeChannel(a)}}},[t,l,g,S]);const _=async a=>{if(!(!l||!t))try{const{data:r,error:i}=await d.from("ticket_messages").insert([{ticket_id:t,user_id:l.id,message:a.message,is_staff:!1}]).select().single();if(i)throw i;w(),r&&f(o=>o.some(T=>T.id===r.id)?o:[...o,r])}catch(r){console.error("Error sending message:",r)}};return b?s.jsx("div",{className:"container",style:{paddingTop:"6rem"},children:c("common.loading")}):s.jsxs("div",{className:"container",style:{paddingTop:"6rem",minHeight:"90vh",display:"flex",flexDirection:"column"},children:[s.jsxs("div",{style:{marginBottom:"1rem",display:"flex",alignItems:"center",gap:"1rem"},children:[s.jsx("button",{onClick:()=>m("/support"),style:{background:"none",border:"none",color:"white",fontSize:"1.2rem",cursor:"pointer"},children:s.jsx(k,{})}),s.jsxs("div",{children:[s.jsxs("h2",{style:{margin:0},children:[e==null?void 0:e.subject," ",s.jsxs("span",{style:{fontSize:"0.8rem",opacity:.7},children:["#",t==null?void 0:t.slice(0,6)]})]}),s.jsx("span",{className:`badge ${e==null?void 0:e.status}`,style:{padding:"0.2rem 0.6rem",borderRadius:"1rem",fontSize:"0.7rem",background:(e==null?void 0:e.status)==="open"?"#2ecc71":"#95a5a6",color:"#000",fontWeight:"bold",marginTop:"0.3rem",display:"inline-block"},children:e==null?void 0:e.status.toUpperCase()})]})]}),s.jsxs("div",{className:"chat-window",style:{flex:1,background:"rgba(0,0,0,0.3)",borderRadius:"1rem",border:"1px solid var(--border)",display:"flex",flexDirection:"column",overflow:"hidden"},children:[s.jsxs("div",{style:{flex:1,padding:"1.5rem",overflowY:"auto",display:"flex",flexDirection:"column",gap:"1rem"},children:[h.map(a=>{const r=l&&a.user_id===l.id;return s.jsxs(R.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},style:{alignSelf:r?"flex-end":"flex-start",maxWidth:"70%",display:"flex",flexDirection:"column",alignItems:r?"flex-end":"flex-start"},children:[s.jsxs("div",{style:{background:r?"var(--accent)":"#2c3e50",color:"white",padding:"0.8rem 1.2rem",borderRadius:r?"1rem 1rem 0 1rem":"1rem 1rem 1rem 0",position:"relative",boxShadow:"0 2px 5px rgba(0,0,0,0.2)"},children:[a.is_staff&&s.jsxs("div",{style:{position:"absolute",top:"-10px",left:"-10px",background:"#e74c3c",color:"white",padding:"0.2rem 0.5rem",borderRadius:"0.5rem",fontSize:"0.6rem",fontWeight:"bold",display:"flex",alignItems:"center",gap:"0.2rem"},children:[s.jsx(D,{size:10})," STAFF"]}),a.message]}),s.jsx("span",{style:{fontSize:"0.65rem",color:"var(--muted)",marginTop:"0.3rem"},children:new Date(a.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]},a.id)}),s.jsx("div",{ref:u})]}),s.jsxs("form",{onSubmit:v(_),style:{padding:"1rem",background:"var(--card-bg)",borderTop:"1px solid var(--border)",display:"flex",gap:"1rem"},children:[s.jsx("input",{type:"text",placeholder:(e==null?void 0:e.status)==="closed"?c("support.ticket_closed"):c("support.type_message"),...j("message"),disabled:(e==null?void 0:e.status)==="closed"||p,style:{flex:1,padding:"0.8rem",borderRadius:"2rem",background:"#0f0f1a",border:"1px solid #333",color:"white"}}),s.jsx("button",{type:"submit",disabled:(e==null?void 0:e.status)==="closed"||p,className:"cta-button",style:{width:"45px",height:"45px",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",padding:0},children:s.jsx(E,{size:18})})]})]})]})}export{P as default};
//# sourceMappingURL=TicketDetail-DXWrm8K4.js.map
