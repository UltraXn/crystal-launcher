{"version":3,"file":"TicketDetail-DXWrm8K4.js","sources":["../../src/pages/TicketDetail.tsx"],"sourcesContent":["import { useState, useEffect, useRef, useCallback } from 'react'\r\nimport { useParams, useNavigate } from 'react-router-dom'\r\nimport { useForm } from 'react-hook-form'\r\nimport { zodResolver } from '@hookform/resolvers/zod'\r\nimport { addTicketMessageSchema, AddTicketMessageFormValues } from '../schemas/ticket'\r\n \r\nimport { motion } from 'framer-motion'\r\nimport { useAuth } from '../context/AuthContext'\r\nimport { supabase } from '../services/supabaseClient'\r\nimport { Send, ArrowLeft, Shield } from 'lucide-react'\r\nimport { useTranslation } from 'react-i18next'\r\n\r\ninterface TicketDetailData {\r\n    id: string;\r\n    subject: string;\r\n    status: string;\r\n    category: string;\r\n    created_at: string;\r\n}\r\n\r\ninterface TicketMessage {\r\n    id: string;\r\n    user_id: string;\r\n    message: string;\r\n    is_staff: boolean;\r\n    created_at: string;\r\n}\r\n\r\nexport default function TicketDetail() {\r\n    const { id } = useParams()\r\n    const { user } = useAuth()\r\n    const { t } = useTranslation()\r\n    const navigate = useNavigate()\r\n    const messagesEndRef = useRef<HTMLDivElement | null>(null)\r\n\r\n    const [ticket, setTicket] = useState<TicketDetailData | null>(null)\r\n    const [messages, setMessages] = useState<TicketMessage[]>([])\r\n    const [loading, setLoading] = useState(true)\r\n\r\n    const { register, handleSubmit, reset, formState: { isSubmitting } } = useForm<AddTicketMessageFormValues>({\r\n        resolver: zodResolver(addTicketMessageSchema)\r\n    })\r\n\r\n    const scrollToBottom = useCallback(() => {\r\n        setTimeout(() => {\r\n            if (messagesEndRef.current) {\r\n                messagesEndRef.current.scrollIntoView({ behavior: 'smooth' })\r\n            }\r\n        }, 100)\r\n    }, [])\r\n\r\n    const fetchTicketData = useCallback(async () => {\r\n        if (!id) return\r\n        try {\r\n            // Fetch Ticket Info\r\n            const { data: ticketData, error: ticketError } = await supabase\r\n                .from('tickets')\r\n                .select('*')\r\n                .eq('id', id)\r\n                .single()\r\n            \r\n            if (ticketError) throw ticketError\r\n            setTicket(ticketData)\r\n\r\n            // Fetch Messages\r\n            const { data: msgs, error: msgsError } = await supabase\r\n                .from('ticket_messages')\r\n                .select('*')\r\n                .eq('ticket_id', id)\r\n                .order('created_at', { ascending: true })\r\n\r\n            if (msgsError) throw msgsError\r\n            setMessages(msgs || [])\r\n            setLoading(false)\r\n            // scrollToBottom()\r\n        } catch (error) {\r\n            console.error('Error fetching details:', error)\r\n            navigate('/support') // Fallback if not authorized or not found\r\n        }\r\n    }, [id, navigate])\r\n\r\n    useEffect(() => {\r\n        if (id && user) {\r\n            fetchTicketData()\r\n            \r\n            // Subscribe to real-time messages\r\n            const channel = supabase\r\n                .channel(`ticket_chat_${id}`)\r\n                .on('postgres_changes', { \r\n                    event: 'INSERT', \r\n                    schema: 'public', \r\n                    table: 'ticket_messages',\r\n                    filter: `ticket_id=eq.${id}`\r\n                }, (payload: { new: TicketMessage }) => {\r\n                    setMessages(prev => {\r\n                        if (prev.some(m => m.id === payload.new.id)) return prev;\r\n                        return [...prev, payload.new as TicketMessage];\r\n                    })\r\n                    // scrollToBottom() - User requested removal\r\n                })\r\n                .subscribe()\r\n\r\n            return () => {\r\n                supabase.removeChannel(channel)\r\n            }\r\n        }\r\n    }, [id, user, fetchTicketData, scrollToBottom])\r\n\r\n    const handleSendMessage = async (data: AddTicketMessageFormValues) => {\r\n        if (!user || !id) return\r\n\r\n        try {\r\n            const { data: messageData, error } = await supabase\r\n                .from('ticket_messages')\r\n                .insert([{\r\n                    ticket_id: id,\r\n                    user_id: user.id,\r\n                    message: data.message,\r\n                    is_staff: false\r\n                }])\r\n                .select()\r\n                .single()\r\n\r\n            if (error) throw error\r\n            \r\n            reset() // Clear input\r\n            \r\n            // Optimistic update (or rather, immediate post-request update)\r\n            if (messageData) {\r\n                setMessages(prev => {\r\n                    if (prev.some(m => m.id === messageData.id)) return prev\r\n                    return [...prev, messageData as TicketMessage]\r\n                })\r\n            }\r\n        } catch (error) {\r\n            console.error('Error sending message:', error)\r\n        }\r\n    }\r\n\r\n    if (loading) return <div className=\"container\" style={{paddingTop: '6rem'}}>{t('common.loading')}</div>\r\n\r\n    return (\r\n        <div className=\"container\" style={{paddingTop: '6rem', minHeight: '90vh', display: 'flex', flexDirection: 'column'}}>\r\n            \r\n            {/* Header */}\r\n            <div style={{marginBottom: '1rem', display: 'flex', alignItems: 'center', gap: '1rem'}}>\r\n                <button onClick={() => navigate('/support')} style={{background: 'none', border: 'none', color: 'white', fontSize: '1.2rem', cursor: 'pointer'}}>\r\n                    <ArrowLeft />\r\n                </button>\r\n                <div>\r\n                    <h2 style={{margin: 0}}>{ticket?.subject} <span style={{fontSize: '0.8rem', opacity: 0.7}}>#{id?.slice(0, 6)}</span></h2>\r\n                    <span className={`badge ${ticket?.status}`} style={{\r\n                        padding: '0.2rem 0.6rem', \r\n                        borderRadius: '1rem', \r\n                        fontSize: '0.7rem',\r\n                        background: ticket?.status === 'open' ? '#2ecc71' : '#95a5a6',\r\n                        color: '#000',\r\n                        fontWeight: 'bold',\r\n                        marginTop: '0.3rem',\r\n                        display: 'inline-block'\r\n                    }}>\r\n                        {ticket?.status.toUpperCase()}\r\n                    </span>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Chat Area */}\r\n            <div className=\"chat-window\" style={{\r\n                flex: 1,\r\n                background: 'rgba(0,0,0,0.3)',\r\n                borderRadius: '1rem',\r\n                border: '1px solid var(--border)',\r\n                display: 'flex',\r\n                flexDirection: 'column',\r\n                overflow: 'hidden'\r\n            }}>\r\n                {/* Messages List */}\r\n                <div style={{flex: 1, padding: '1.5rem', overflowY: 'auto', display: 'flex', flexDirection: 'column', gap: '1rem'}}>\r\n                    {messages.map((msg) => {\r\n                        const isMe = user && msg.user_id === user.id\r\n                        // If is_staff is true OR the message is not from me (assuming admin response)\r\n                        // In reality, staff messages might come from bot (user_id specific) or dashboard\r\n                        \r\n                        return (\r\n                            <motion.div \r\n                                key={msg.id}\r\n                                initial={{opacity: 0, scale: 0.9}}\r\n                                animate={{opacity: 1, scale: 1}}\r\n                                style={{\r\n                                    alignSelf: isMe ? 'flex-end' : 'flex-start',\r\n                                    maxWidth: '70%',\r\n                                    display: 'flex',\r\n                                    flexDirection: 'column',\r\n                                    alignItems: isMe ? 'flex-end' : 'flex-start'\r\n                                }}\r\n                            >\r\n                                <div style={{\r\n                                    background: isMe ? 'var(--accent)' : '#2c3e50',\r\n                                    color: 'white',\r\n                                    padding: '0.8rem 1.2rem',\r\n                                    borderRadius: isMe ? '1rem 1rem 0 1rem' : '1rem 1rem 1rem 0',\r\n                                    position: 'relative',\r\n                                    boxShadow: '0 2px 5px rgba(0,0,0,0.2)'\r\n                                }}>\r\n                                    {msg.is_staff && (\r\n                                        <div style={{\r\n                                            position: 'absolute', top: '-10px', left: '-10px',\r\n                                            background: '#e74c3c', color: 'white', \r\n                                            padding: '0.2rem 0.5rem', borderRadius: '0.5rem',\r\n                                            fontSize: '0.6rem', fontWeight: 'bold',\r\n                                            display: 'flex', alignItems: 'center', gap: '0.2rem'\r\n                                        }}>\r\n                                            <Shield size={10} /> STAFF\r\n                                        </div>\r\n                                    )}\r\n                                    {msg.message}\r\n                                </div>\r\n                                <span style={{fontSize: '0.65rem', color: 'var(--muted)', marginTop: '0.3rem'}}>\r\n                                    {new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}\r\n                                </span>\r\n                            </motion.div>\r\n                        )\r\n                    })}\r\n                    <div ref={messagesEndRef} />\r\n                </div>\r\n\r\n                {/* Input Area */}\r\n                <form onSubmit={handleSubmit(handleSendMessage)} style={{\r\n                    padding: '1rem', \r\n                    background: 'var(--card-bg)', \r\n                    borderTop: '1px solid var(--border)',\r\n                    display: 'flex',\r\n                    gap: '1rem'\r\n                }}>\r\n                    <input \r\n                        type=\"text\" \r\n                        placeholder={ticket?.status === 'closed' ? t('support.ticket_closed') : t('support.type_message')}\r\n                        {...register('message')}\r\n                        disabled={ticket?.status === 'closed' || isSubmitting}\r\n                        style={{\r\n                            flex: 1, padding: '0.8rem', borderRadius: '2rem', \r\n                            background: '#0f0f1a', border: '1px solid #333', color: 'white'\r\n                        }}\r\n                    />\r\n                    <button \r\n                        type=\"submit\" \r\n                        disabled={ticket?.status === 'closed' || isSubmitting}\r\n                        className=\"cta-button\"\r\n                        style={{\r\n                            width: '45px', height: '45px', borderRadius: '50%', \r\n                            display: 'flex', alignItems: 'center', justifyContent: 'center',\r\n                            padding: 0\r\n                        }}\r\n                    >\r\n                        <Send size={18} />\r\n                    </button>\r\n                </form>\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n"],"names":["TicketDetail","id","useParams","user","useAuth","t","useTranslation","navigate","useNavigate","messagesEndRef","useRef","ticket","setTicket","useState","messages","setMessages","loading","setLoading","register","handleSubmit","reset","isSubmitting","useForm","zodResolver","addTicketMessageSchema","scrollToBottom","useCallback","fetchTicketData","ticketData","ticketError","supabase","msgs","msgsError","error","useEffect","channel","payload","prev","m","handleSendMessage","data","messageData","jsx","jsxs","ArrowLeft","msg","isMe","motion","Shield","Send"],"mappings":"yTA4BA,SAAwBA,GAAe,CACnC,KAAM,CAAE,GAAAC,CAAA,EAAOC,EAAA,EACT,CAAE,KAAAC,CAAA,EAASC,EAAA,EACX,CAAE,EAAAC,CAAA,EAAMC,EAAA,EACRC,EAAWC,EAAA,EACXC,EAAiBC,EAAAA,OAA8B,IAAI,EAEnD,CAACC,EAAQC,CAAS,EAAIC,EAAAA,SAAkC,IAAI,EAC5D,CAACC,EAAUC,CAAW,EAAIF,EAAAA,SAA0B,CAAA,CAAE,EACtD,CAACG,EAASC,CAAU,EAAIJ,EAAAA,SAAS,EAAI,EAErC,CAAE,SAAAK,EAAU,aAAAC,EAAc,MAAAC,EAAO,UAAW,CAAE,aAAAC,CAAA,CAAa,EAAMC,EAAoC,CACvG,SAAUC,EAAYC,CAAsB,CAAA,CAC/C,EAEKC,EAAiBC,EAAAA,YAAY,IAAM,CACrC,WAAW,IAAM,CACTjB,EAAe,SACfA,EAAe,QAAQ,eAAe,CAAE,SAAU,SAAU,CAEpE,EAAG,GAAG,CACV,EAAG,CAAA,CAAE,EAECkB,EAAkBD,EAAAA,YAAY,SAAY,CAC5C,GAAKzB,EACL,GAAI,CAEA,KAAM,CAAE,KAAM2B,EAAY,MAAOC,CAAA,EAAgB,MAAMC,EAClD,KAAK,SAAS,EACd,OAAO,GAAG,EACV,GAAG,KAAM7B,CAAE,EACX,OAAA,EAEL,GAAI4B,EAAa,MAAMA,EACvBjB,EAAUgB,CAAU,EAGpB,KAAM,CAAE,KAAMG,EAAM,MAAOC,GAAc,MAAMF,EAC1C,KAAK,iBAAiB,EACtB,OAAO,GAAG,EACV,GAAG,YAAa7B,CAAE,EAClB,MAAM,aAAc,CAAE,UAAW,GAAM,EAE5C,GAAI+B,EAAW,MAAMA,EACrBjB,EAAYgB,GAAQ,EAAE,EACtBd,EAAW,EAAK,CAEpB,OAASgB,EAAO,CACZ,QAAQ,MAAM,0BAA2BA,CAAK,EAC9C1B,EAAS,UAAU,CACvB,CACJ,EAAG,CAACN,EAAIM,CAAQ,CAAC,EAEjB2B,EAAAA,UAAU,IAAM,CACZ,GAAIjC,GAAME,EAAM,CACZwB,EAAA,EAGA,MAAMQ,EAAUL,EACX,QAAQ,eAAe7B,CAAE,EAAE,EAC3B,GAAG,mBAAoB,CACpB,MAAO,SACP,OAAQ,SACR,MAAO,kBACP,OAAQ,gBAAgBA,CAAE,EAAA,EAC1BmC,GAAoC,CACpCrB,EAAYsB,GACJA,EAAK,KAAKC,GAAKA,EAAE,KAAOF,EAAQ,IAAI,EAAE,EAAUC,EAC7C,CAAC,GAAGA,EAAMD,EAAQ,GAAoB,CAChD,CAEL,CAAC,EACA,UAAA,EAEL,MAAO,IAAM,CACTN,EAAS,cAAcK,CAAO,CAClC,CACJ,CACJ,EAAG,CAAClC,EAAIE,EAAMwB,EAAiBF,CAAc,CAAC,EAE9C,MAAMc,EAAoB,MAAOC,GAAqC,CAClE,GAAI,GAACrC,GAAQ,CAACF,GAEd,GAAI,CACA,KAAM,CAAE,KAAMwC,EAAa,MAAAR,CAAA,EAAU,MAAMH,EACtC,KAAK,iBAAiB,EACtB,OAAO,CAAC,CACL,UAAW7B,EACX,QAASE,EAAK,GACd,QAASqC,EAAK,QACd,SAAU,EAAA,CACb,CAAC,EACD,OAAA,EACA,OAAA,EAEL,GAAIP,EAAO,MAAMA,EAEjBb,EAAA,EAGIqB,GACA1B,EAAYsB,GACJA,EAAK,KAAKC,GAAKA,EAAE,KAAOG,EAAY,EAAE,EAAUJ,EAC7C,CAAC,GAAGA,EAAMI,CAA4B,CAChD,CAET,OAASR,EAAO,CACZ,QAAQ,MAAM,yBAA0BA,CAAK,CACjD,CACJ,EAEA,OAAIjB,EAAgB0B,EAAAA,IAAC,MAAA,CAAI,UAAU,YAAY,MAAO,CAAC,WAAY,MAAA,EAAU,SAAArC,EAAE,gBAAgB,CAAA,CAAE,EAG7FsC,EAAAA,KAAC,MAAA,CAAI,UAAU,YAAY,MAAO,CAAC,WAAY,OAAQ,UAAW,OAAQ,QAAS,OAAQ,cAAe,UAGtG,SAAA,CAAAA,EAAAA,KAAC,MAAA,CAAI,MAAO,CAAC,aAAc,OAAQ,QAAS,OAAQ,WAAY,SAAU,IAAK,MAAA,EAC3E,SAAA,CAAAD,EAAAA,IAAC,SAAA,CAAO,QAAS,IAAMnC,EAAS,UAAU,EAAG,MAAO,CAAC,WAAY,OAAQ,OAAQ,OAAQ,MAAO,QAAS,SAAU,SAAU,OAAQ,WACjI,SAAAmC,EAAAA,IAACE,EAAA,CAAA,CAAU,CAAA,CACf,SACC,MAAA,CACG,SAAA,CAAAD,EAAAA,KAAC,KAAA,CAAG,MAAO,CAAC,OAAQ,GAAK,SAAA,CAAAhC,GAAA,YAAAA,EAAQ,QAAQ,IAACgC,OAAC,QAAK,MAAO,CAAC,SAAU,SAAU,QAAS,IAAM,SAAA,CAAA,IAAE1C,GAAA,YAAAA,EAAI,MAAM,EAAG,EAAC,CAAA,CAAE,CAAA,EAAO,QACnH,OAAA,CAAK,UAAW,SAASU,GAAA,YAAAA,EAAQ,MAAM,GAAI,MAAO,CAC/C,QAAS,gBACT,aAAc,OACd,SAAU,SACV,YAAYA,GAAA,YAAAA,EAAQ,UAAW,OAAS,UAAY,UACpD,MAAO,OACP,WAAY,OACZ,UAAW,SACX,QAAS,cAAA,EAER,SAAAA,GAAA,YAAAA,EAAQ,OAAO,aAAY,CAChC,CAAA,CAAA,CACJ,CAAA,EACJ,EAGAgC,EAAAA,KAAC,MAAA,CAAI,UAAU,cAAc,MAAO,CAChC,KAAM,EACN,WAAY,kBACZ,aAAc,OACd,OAAQ,0BACR,QAAS,OACT,cAAe,SACf,SAAU,QAAA,EAGV,SAAA,CAAAA,EAAAA,KAAC,MAAA,CAAI,MAAO,CAAC,KAAM,EAAG,QAAS,SAAU,UAAW,OAAQ,QAAS,OAAQ,cAAe,SAAU,IAAK,QACtG,SAAA,CAAA7B,EAAS,IAAK+B,GAAQ,CACnB,MAAMC,EAAO3C,GAAQ0C,EAAI,UAAY1C,EAAK,GAI1C,OACIwC,EAAAA,KAACI,EAAO,IAAP,CAEG,QAAS,CAAC,QAAS,EAAG,MAAO,EAAA,EAC7B,QAAS,CAAC,QAAS,EAAG,MAAO,CAAA,EAC7B,MAAO,CACH,UAAWD,EAAO,WAAa,aAC/B,SAAU,MACV,QAAS,OACT,cAAe,SACf,WAAYA,EAAO,WAAa,YAAA,EAGpC,SAAA,CAAAH,OAAC,OAAI,MAAO,CACR,WAAYG,EAAO,gBAAkB,UACrC,MAAO,QACP,QAAS,gBACT,aAAcA,EAAO,mBAAqB,mBAC1C,SAAU,WACV,UAAW,2BAAA,EAEV,SAAA,CAAAD,EAAI,UACDF,EAAAA,KAAC,MAAA,CAAI,MAAO,CACR,SAAU,WAAY,IAAK,QAAS,KAAM,QAC1C,WAAY,UAAW,MAAO,QAC9B,QAAS,gBAAiB,aAAc,SACxC,SAAU,SAAU,WAAY,OAChC,QAAS,OAAQ,WAAY,SAAU,IAAK,QAAA,EAE5C,SAAA,CAAAD,EAAAA,IAACM,EAAA,CAAO,KAAM,EAAA,CAAI,EAAE,QAAA,EACxB,EAEHH,EAAI,OAAA,EACT,EACAH,EAAAA,IAAC,OAAA,CAAK,MAAO,CAAC,SAAU,UAAW,MAAO,eAAgB,UAAW,UAChE,SAAA,IAAI,KAAKG,EAAI,UAAU,EAAE,mBAAmB,CAAA,EAAI,CAAC,KAAM,UAAW,OAAO,SAAA,CAAU,CAAA,CACxF,CAAA,CAAA,EAlCKA,EAAI,EAAA,CAqCrB,CAAC,EACDH,EAAAA,IAAC,MAAA,CAAI,IAAKjC,CAAA,CAAgB,CAAA,EAC9B,SAGC,OAAA,CAAK,SAAUU,EAAaoB,CAAiB,EAAG,MAAO,CACpD,QAAS,OACT,WAAY,iBACZ,UAAW,0BACX,QAAS,OACT,IAAK,MAAA,EAEL,SAAA,CAAAG,EAAAA,IAAC,QAAA,CACG,KAAK,OACL,aAAa/B,GAAA,YAAAA,EAAQ,UAAW,SAAWN,EAAE,uBAAuB,EAAIA,EAAE,sBAAsB,EAC/F,GAAGa,EAAS,SAAS,EACtB,UAAUP,GAAA,YAAAA,EAAQ,UAAW,UAAYU,EACzC,MAAO,CACH,KAAM,EAAG,QAAS,SAAU,aAAc,OAC1C,WAAY,UAAW,OAAQ,iBAAkB,MAAO,OAAA,CAC5D,CAAA,EAEJqB,EAAAA,IAAC,SAAA,CACG,KAAK,SACL,UAAU/B,GAAA,YAAAA,EAAQ,UAAW,UAAYU,EACzC,UAAU,aACV,MAAO,CACH,MAAO,OAAQ,OAAQ,OAAQ,aAAc,MAC7C,QAAS,OAAQ,WAAY,SAAU,eAAgB,SACvD,QAAS,CAAA,EAGb,SAAAqB,EAAAA,IAACO,EAAA,CAAK,KAAM,EAAA,CAAI,CAAA,CAAA,CACpB,CAAA,CACJ,CAAA,CAAA,CACJ,CAAA,EACJ,CAER"}